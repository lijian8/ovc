/* SPDX-License-Identifier: GPL-2.0
 * Copyright (C) 2020 Open Source Robotics Foundation
 *
 * Camera description and initialization for Picam HQ (imx477).
 *
 * Based on:
 * crl_imx477_master_configuration.h
 * Copyright (C) 2017 - 2018 Intel Corporation
 *
 * Author: Alexei Zavjalov <alexei.zavjalov@intel.com>
 *
 * V4L2 driver for Sony IMX477 cameras.
 * Copyright (C) 2020, Raspberry Pi (Trading) Ltd
 *
 * and:
 *
 * imx477.c - imx477 sensor driver
 *
 * Copyright (c) 2020, RidgeRun. All rights reserved.
 */

#ifndef CAMERAS__PICAM_HQ_INC
#define CAMERAS__PICAM_HQ_INC

#include <ovc4_driver/camera.hpp>

// PiCamera V3 (or HQ), based on Sony IMX477
class PiCameraHQ : public Camera
{
  static constexpr uint16_t CHIP_ID_MSB_REGADDR = 0x0016;
  static constexpr uint16_t CHIP_ID_LSB_REGADDR = 0x0017;

  static constexpr uint16_t CHIP_ID = 0x0477;

  static constexpr uint16_t COARSE_TIME_MSB_REGADDR = 0x0202;
  static constexpr uint16_t COARSE_TIME_LSB_REGADDR = 0x0203;
  static constexpr uint16_t GAIN_REGADDR = 0x0204;

  static constexpr int16_t MAX_COARSE_DIFF = 0x000A;
  static constexpr int16_t MIN_COARSE_EXPOSURE = 0x0001;

  static constexpr int16_t MIN_GAIN = 0x0000;
  static constexpr int16_t MAX_GAIN = (978);
  // TODO those from device tree
  static constexpr int32_t PIXEL_CLOCK = 840000000;
  static constexpr int32_t FRAMERATE_FACTOR = 1000000;
  static constexpr int32_t LINE_LENGTH = 9024;
  static constexpr int32_t EXPOSURE_FACTOR = 1000000;
  static constexpr int32_t GAIN_FACTOR = 16;

  const regop_t enable_streaming_regop = writeRegOp(0x0100, 0x01);

  const regop_t reset_regop = writeRegOp(0x0103, 0x01);

  const std::vector<regop_t> common_ops =
  {
    // Taken from Ridgerun driver
    writeRegOp(0x0136, 0x18),
    writeRegOp(0x0137, 0x00),
    writeRegOp(0x0808, 0x02),
    writeRegOp(0xE07A, 0x01),
    writeRegOp(0xE000, 0x00),
    writeRegOp(0x4AE9, 0x18),
    writeRegOp(0x4AEA, 0x08),
    writeRegOp(0xF61C, 0x04),
    writeRegOp(0xF61E, 0x04),
    writeRegOp(0x4AE9, 0x21),
    writeRegOp(0x4AEA, 0x80),
    writeRegOp(0x38A8, 0x1F),
    writeRegOp(0x38A9, 0xFF),
    writeRegOp(0x38AA, 0x1F),
    writeRegOp(0x38AB, 0xFF),
    writeRegOp(0x420B, 0x01),
    writeRegOp(0x55D4, 0x00),
    writeRegOp(0x55D5, 0x00),
    writeRegOp(0x55D6, 0x07),
    writeRegOp(0x55D7, 0xFF),
    writeRegOp(0x55E8, 0x07),
    writeRegOp(0x55E9, 0xFF),
    writeRegOp(0x55EA, 0x00),
    writeRegOp(0x55EB, 0x00),
    writeRegOp(0x574C, 0x07),
    writeRegOp(0x574D, 0xFF),
    writeRegOp(0x574E, 0x00),
    writeRegOp(0x574F, 0x00),
    writeRegOp(0x5754, 0x00),
    writeRegOp(0x5755, 0x00),
    writeRegOp(0x5756, 0x07),
    writeRegOp(0x5757, 0xFF),
    writeRegOp(0x5973, 0x04),
    writeRegOp(0x5974, 0x01),
    writeRegOp(0x5D13, 0xC3),
    writeRegOp(0x5D14, 0x58),
    writeRegOp(0x5D15, 0xA3),
    writeRegOp(0x5D16, 0x1D),
    writeRegOp(0x5D17, 0x65),
    writeRegOp(0x5D18, 0x8C),
    writeRegOp(0x5D1A, 0x06),
    writeRegOp(0x5D1B, 0xA9),
    writeRegOp(0x5D1C, 0x45),
    writeRegOp(0x5D1D, 0x3A),
    writeRegOp(0x5D1E, 0xAB),
    writeRegOp(0x5D1F, 0x15),
    writeRegOp(0x5D21, 0x0E),
    writeRegOp(0x5D22, 0x52),
    writeRegOp(0x5D23, 0xAA),
    writeRegOp(0x5D24, 0x7D),
    writeRegOp(0x5D25, 0x57),
    writeRegOp(0x5D26, 0xA8),
    writeRegOp(0x5D37, 0x5A),
    writeRegOp(0x5D38, 0x5A),
    writeRegOp(0x5D77, 0x7F),
    writeRegOp(0x7B7C, 0x00),
    writeRegOp(0x7B7D, 0x00),
    writeRegOp(0x8D1F, 0x00),
    writeRegOp(0x8D27, 0x00),
    writeRegOp(0x9004, 0x03),
    writeRegOp(0x9200, 0x50),
    writeRegOp(0x9201, 0x6C),
    writeRegOp(0x9202, 0x71),
    writeRegOp(0x9203, 0x00),
    writeRegOp(0x9204, 0x71),
    writeRegOp(0x9205, 0x01),
    writeRegOp(0x9371, 0x6A),
    writeRegOp(0x9373, 0x6A),
    writeRegOp(0x9375, 0x64),
    writeRegOp(0x990C, 0x00),
    writeRegOp(0x990D, 0x08),
    writeRegOp(0x9956, 0x8C),
    writeRegOp(0x9957, 0x64),
    writeRegOp(0x9958, 0x50),
    writeRegOp(0x9A48, 0x06),
    writeRegOp(0x9A49, 0x06),
    writeRegOp(0x9A4A, 0x06),
    writeRegOp(0x9A4B, 0x06),
    writeRegOp(0x9A4C, 0x06),
    writeRegOp(0x9A4D, 0x06),
    writeRegOp(0xA001, 0x0A),
    writeRegOp(0xA003, 0x0A),
    writeRegOp(0xA005, 0x0A),
    writeRegOp(0xA006, 0x01),
    writeRegOp(0xA007, 0xC0),
    writeRegOp(0xA009, 0xC0),
    writeRegOp(0x4bd5, 0x16),
    writeRegOp(0x4bdd, 0x15),
    writeRegOp(0x42b0, 0x00),
    writeRegOp(0x42a9, 0xfe),
    writeRegOp(0x42aa, 0xfd),
    writeRegOp(0x4270, 0x00),
    writeRegOp(0x3040, 0x01),
    writeRegOp(0x3D8A, 0x01),
    writeRegOp(0x7B3B, 0x01),
    writeRegOp(0x7B4C, 0x00),
    writeRegOp(0x9905, 0x00),
    writeRegOp(0x9907, 0x00),
    writeRegOp(0x9909, 0x00),
    writeRegOp(0x990B, 0x00),
    writeRegOp(0x9944, 0x3C),
    writeRegOp(0x9947, 0x3C),
    writeRegOp(0x994A, 0x8C),
    writeRegOp(0x994B, 0x50),
    writeRegOp(0x994C, 0x1B),
    writeRegOp(0x994D, 0x8C),
    writeRegOp(0x994E, 0x50),
    writeRegOp(0x994F, 0x1B),
    writeRegOp(0x9950, 0x8C),
    writeRegOp(0x9951, 0x1B),
    writeRegOp(0x9952, 0x0A),
    writeRegOp(0x9953, 0x8C),
    writeRegOp(0x9954, 0x1B),
    writeRegOp(0x9955, 0x0A),
    writeRegOp(0x9A13, 0x04),
    writeRegOp(0x9A14, 0x04),
    writeRegOp(0x9A19, 0x00),
    writeRegOp(0x9A1C, 0x04),
    writeRegOp(0x9A1D, 0x04),
    writeRegOp(0x9A26, 0x05),
    writeRegOp(0x9A27, 0x05),
    writeRegOp(0x9A2C, 0x01),
    writeRegOp(0x9A2D, 0x03),
    writeRegOp(0x9A2F, 0x05),
    writeRegOp(0x9A30, 0x05),
    writeRegOp(0x9A41, 0x00),
    writeRegOp(0x9A46, 0x00),
    writeRegOp(0x9A47, 0x00),
    writeRegOp(0x9C17, 0x35),
    writeRegOp(0x9C1D, 0x31),
    writeRegOp(0x9C29, 0x50),
    writeRegOp(0x9C3B, 0x2F),
    writeRegOp(0x9C41, 0x6B),
    writeRegOp(0x9C47, 0x2D),
    writeRegOp(0x9C4D, 0x40),
    writeRegOp(0x9C6B, 0x00),
    writeRegOp(0x9C71, 0xC8),
    writeRegOp(0x9C73, 0x32),
    writeRegOp(0x9C75, 0x04),
    writeRegOp(0x9C7D, 0x2D),
    writeRegOp(0x9C83, 0x40),
    writeRegOp(0x9C94, 0x3F),
    writeRegOp(0x9C95, 0x3F),
    writeRegOp(0x9C96, 0x3F),
    writeRegOp(0x9C97, 0x00),
    writeRegOp(0x9C98, 0x00),
    writeRegOp(0x9C99, 0x00),
    writeRegOp(0x9C9A, 0x3F),
    writeRegOp(0x9C9B, 0x3F),
    writeRegOp(0x9C9C, 0x3F),
    writeRegOp(0x9CA0, 0x0F),
    writeRegOp(0x9CA1, 0x0F),
    writeRegOp(0x9CA2, 0x0F),
    writeRegOp(0x9CA3, 0x00),
    writeRegOp(0x9CA4, 0x00),
    writeRegOp(0x9CA5, 0x00),
    writeRegOp(0x9CA6, 0x1E),
    writeRegOp(0x9CA7, 0x1E),
    writeRegOp(0x9CA8, 0x1E),
    writeRegOp(0x9CA9, 0x00),
    writeRegOp(0x9CAA, 0x00),
    writeRegOp(0x9CAB, 0x00),
    writeRegOp(0x9CAC, 0x09),
    writeRegOp(0x9CAD, 0x09),
    writeRegOp(0x9CAE, 0x09),
    writeRegOp(0x9CBD, 0x50),
    writeRegOp(0x9CBF, 0x50),
    writeRegOp(0x9CC1, 0x50),
    writeRegOp(0x9CC3, 0x40),
    writeRegOp(0x9CC5, 0x40),
    writeRegOp(0x9CC7, 0x40),
    writeRegOp(0x9CC9, 0x0A),
    writeRegOp(0x9CCB, 0x0A),
    writeRegOp(0x9CCD, 0x0A),
    writeRegOp(0x9D17, 0x35),
    writeRegOp(0x9D1D, 0x31),
    writeRegOp(0x9D29, 0x50),
    writeRegOp(0x9D3B, 0x2F),
    writeRegOp(0x9D41, 0x6B),
    writeRegOp(0x9D47, 0x42),
    writeRegOp(0x9D4D, 0x5A),
    writeRegOp(0x9D6B, 0x00),
    writeRegOp(0x9D71, 0xC8),
    writeRegOp(0x9D73, 0x32),
    writeRegOp(0x9D75, 0x04),
    writeRegOp(0x9D7D, 0x42),
    writeRegOp(0x9D83, 0x5A),
    writeRegOp(0x9D94, 0x3F),
    writeRegOp(0x9D95, 0x3F),
    writeRegOp(0x9D96, 0x3F),
    writeRegOp(0x9D97, 0x00),
    writeRegOp(0x9D98, 0x00),
    writeRegOp(0x9D99, 0x00),
    writeRegOp(0x9D9A, 0x3F),
    writeRegOp(0x9D9B, 0x3F),
    writeRegOp(0x9D9C, 0x3F),
    writeRegOp(0x9D9D, 0x1F),
    writeRegOp(0x9D9E, 0x1F),
    writeRegOp(0x9D9F, 0x1F),
    writeRegOp(0x9DA0, 0x0F),
    writeRegOp(0x9DA1, 0x0F),
    writeRegOp(0x9DA2, 0x0F),
    writeRegOp(0x9DA3, 0x00),
    writeRegOp(0x9DA4, 0x00),
    writeRegOp(0x9DA5, 0x00),
    writeRegOp(0x9DA6, 0x1E),
    writeRegOp(0x9DA7, 0x1E),
    writeRegOp(0x9DA8, 0x1E),
    writeRegOp(0x9DA9, 0x00),
    writeRegOp(0x9DAA, 0x00),
    writeRegOp(0x9DAB, 0x00),
    writeRegOp(0x9DAC, 0x09),
    writeRegOp(0x9DAD, 0x09),
    writeRegOp(0x9DAE, 0x09),
    writeRegOp(0x9DC9, 0x0A),
    writeRegOp(0x9DCB, 0x0A),
    writeRegOp(0x9DCD, 0x0A),
    writeRegOp(0x9E17, 0x35),
    writeRegOp(0x9E1D, 0x31),
    writeRegOp(0x9E29, 0x50),
    writeRegOp(0x9E3B, 0x2F),
    writeRegOp(0x9E41, 0x6B),
    writeRegOp(0x9E47, 0x2D),
    writeRegOp(0x9E4D, 0x40),
    writeRegOp(0x9E6B, 0x00),
    writeRegOp(0x9E71, 0xC8),
    writeRegOp(0x9E73, 0x32),
    writeRegOp(0x9E75, 0x04),
    writeRegOp(0x9E94, 0x0F),
    writeRegOp(0x9E95, 0x0F),
    writeRegOp(0x9E96, 0x0F),
    writeRegOp(0x9E97, 0x00),
    writeRegOp(0x9E98, 0x00),
    writeRegOp(0x9E99, 0x00),
    writeRegOp(0x9EA0, 0x0F),
    writeRegOp(0x9EA1, 0x0F),
    writeRegOp(0x9EA2, 0x0F),
    writeRegOp(0x9EA3, 0x00),
    writeRegOp(0x9EA4, 0x00),
    writeRegOp(0x9EA5, 0x00),
    writeRegOp(0x9EA6, 0x3F),
    writeRegOp(0x9EA7, 0x3F),
    writeRegOp(0x9EA8, 0x3F),
    writeRegOp(0x9EA9, 0x00),
    writeRegOp(0x9EAA, 0x00),
    writeRegOp(0x9EAB, 0x00),
    writeRegOp(0x9EAC, 0x09),
    writeRegOp(0x9EAD, 0x09),
    writeRegOp(0x9EAE, 0x09),
    writeRegOp(0x9EC9, 0x0A),
    writeRegOp(0x9ECB, 0x0A),
    writeRegOp(0x9ECD, 0x0A),
    writeRegOp(0x9F17, 0x35),
    writeRegOp(0x9F1D, 0x31),
    writeRegOp(0x9F29, 0x50),
    writeRegOp(0x9F3B, 0x2F),
    writeRegOp(0x9F41, 0x6B),
    writeRegOp(0x9F47, 0x42),
    writeRegOp(0x9F4D, 0x5A),
    writeRegOp(0x9F6B, 0x00),
    writeRegOp(0x9F71, 0xC8),
    writeRegOp(0x9F73, 0x32),
    writeRegOp(0x9F75, 0x04),
    writeRegOp(0x9F94, 0x0F),
    writeRegOp(0x9F95, 0x0F),
    writeRegOp(0x9F96, 0x0F),
    writeRegOp(0x9F97, 0x00),
    writeRegOp(0x9F98, 0x00),
    writeRegOp(0x9F99, 0x00),
    writeRegOp(0x9F9A, 0x2F),
    writeRegOp(0x9F9B, 0x2F),
    writeRegOp(0x9F9C, 0x2F),
    writeRegOp(0x9F9D, 0x00),
    writeRegOp(0x9F9E, 0x00),
    writeRegOp(0x9F9F, 0x00),
    writeRegOp(0x9FA0, 0x0F),
    writeRegOp(0x9FA1, 0x0F),
    writeRegOp(0x9FA2, 0x0F),
    writeRegOp(0x9FA3, 0x00),
    writeRegOp(0x9FA4, 0x00),
    writeRegOp(0x9FA5, 0x00),
    writeRegOp(0x9FA6, 0x1E),
    writeRegOp(0x9FA7, 0x1E),
    writeRegOp(0x9FA8, 0x1E),
    writeRegOp(0x9FA9, 0x00),
    writeRegOp(0x9FAA, 0x00),
    writeRegOp(0x9FAB, 0x00),
    writeRegOp(0x9FAC, 0x09),
    writeRegOp(0x9FAD, 0x09),
    writeRegOp(0x9FAE, 0x09),
    writeRegOp(0x9FC9, 0x0A),
    writeRegOp(0x9FCB, 0x0A),
    writeRegOp(0x9FCD, 0x0A),
    writeRegOp(0xA14B, 0xFF),
    writeRegOp(0xA151, 0x0C),
    writeRegOp(0xA153, 0x50),
    writeRegOp(0xA155, 0x02),
    writeRegOp(0xA157, 0x00),
    writeRegOp(0xA1AD, 0xFF),
    writeRegOp(0xA1B3, 0x0C),
    writeRegOp(0xA1B5, 0x50),
    writeRegOp(0xA1B9, 0x00),
    writeRegOp(0xA24B, 0xFF),
    writeRegOp(0xA257, 0x00),
    writeRegOp(0xA2AD, 0xFF),
    writeRegOp(0xA2B9, 0x00),
    writeRegOp(0xB21F, 0x04),
    writeRegOp(0xB35C, 0x00),
    writeRegOp(0xB35E, 0x08)
  };

  const std::unordered_map<std::string, std::vector<regop_t>> modes = 
  { 
    {"4032x3040_30fps",
      {
        // Taken from Ridgerun driver
        writeRegOp(0x0112, 0x0A),
        writeRegOp(0x0113, 0x0A),
        writeRegOp(0x0114, 0x01),
        writeRegOp(0x0342, 0x23),
        writeRegOp(0x0343, 0x40),
        writeRegOp(0x0340, 0x0C),
        writeRegOp(0x0341, 0x1E),
        writeRegOp(0x0344, 0x00),
        writeRegOp(0x0345, 0x00),
        writeRegOp(0x0346, 0x00),
        writeRegOp(0x0347, 0x00),
        writeRegOp(0x0348, 0x0F),
        writeRegOp(0x0349, 0xD7),
        writeRegOp(0x034A, 0x0B),
        writeRegOp(0x034B, 0xDF),
        writeRegOp(0x00E3, 0x00),
        writeRegOp(0x00E4, 0x00),
        writeRegOp(0x00FC, 0x0A),
        writeRegOp(0x00FD, 0x0A),
        writeRegOp(0x00FE, 0x0A),
        writeRegOp(0x00FF, 0x0A),
        writeRegOp(0x0220, 0x00),
        writeRegOp(0x0221, 0x11),
        writeRegOp(0x0381, 0x01),
        writeRegOp(0x0383, 0x01),
        writeRegOp(0x0385, 0x01),
        writeRegOp(0x0387, 0x01),
        writeRegOp(0x0900, 0x00),
        writeRegOp(0x0901, 0x11),
        writeRegOp(0x0902, 0x02),
        writeRegOp(0x3140, 0x02),
        writeRegOp(0x3C00, 0x00),
        writeRegOp(0x3C01, 0x01),
        writeRegOp(0x3C02, 0x9C),
        writeRegOp(0x3F0D, 0x00),
        writeRegOp(0x5748, 0x00),
        writeRegOp(0x5749, 0x00),
        writeRegOp(0x574A, 0x00),
        writeRegOp(0x574B, 0xA4),
        writeRegOp(0x7B75, 0x0E),
        writeRegOp(0x7B76, 0x09),
        writeRegOp(0x7B77, 0x08),
        writeRegOp(0x7B78, 0x06),
        writeRegOp(0x7B79, 0x34),
        writeRegOp(0x7B53, 0x00),
        writeRegOp(0x9369, 0x73),
        writeRegOp(0x936B, 0x64),
        writeRegOp(0x936D, 0x5F),
        writeRegOp(0x9304, 0x03),
        writeRegOp(0x9305, 0x80),
        writeRegOp(0x9E9A, 0x2F),
        writeRegOp(0x9E9B, 0x2F),
        writeRegOp(0x9E9C, 0x2F),
        writeRegOp(0x9E9D, 0x00),
        writeRegOp(0x9E9E, 0x00),
        writeRegOp(0x9E9F, 0x00),
        writeRegOp(0xA2A9, 0x27),
        writeRegOp(0xA2B7, 0x03),
        writeRegOp(0x0401, 0x00),
        writeRegOp(0x0404, 0x00),
        writeRegOp(0x0405, 0x10),
        writeRegOp(0x0408, 0x00),
        writeRegOp(0x0409, 0x0C),
        writeRegOp(0x040A, 0x00),
        writeRegOp(0x040B, 0x00),
        writeRegOp(0x040C, 0x0F),
        writeRegOp(0x040D, 0xC0),
        writeRegOp(0x040E, 0x0B),
        writeRegOp(0x040F, 0xE0),
        writeRegOp(0x034C, 0x0F),
        writeRegOp(0x034D, 0xC0),
        writeRegOp(0x034E, 0x0B),
        writeRegOp(0x034F, 0xE0),
        writeRegOp(0x0301, 0x05),
        writeRegOp(0x0303, 0x02),
        writeRegOp(0x0305, 0x02),
        writeRegOp(0x0306, 0x00),
        writeRegOp(0x0307, 0xAF),
        writeRegOp(0x0309, 0x0A),
        writeRegOp(0x030B, 0x01),
        writeRegOp(0x030D, 0x03),
        writeRegOp(0x030E, 0x01),
        writeRegOp(0x030F, 0x06),
        writeRegOp(0x0310, 0x01),
        writeRegOp(0x0820, 0x20),
        writeRegOp(0x0821, 0xC0),
        writeRegOp(0x0822, 0x00),
        writeRegOp(0x0823, 0x00),
        writeRegOp(0x080A, 0x00),
        writeRegOp(0x080B, 0xC7),
        writeRegOp(0x080C, 0x00),
        writeRegOp(0x080D, 0x87),
        writeRegOp(0x080E, 0x00),
        writeRegOp(0x080F, 0xDF),
        writeRegOp(0x0810, 0x00),
        writeRegOp(0x0811, 0x97),
        writeRegOp(0x0812, 0x00),
        writeRegOp(0x0813, 0x8F),
        writeRegOp(0x0814, 0x00),
        writeRegOp(0x0815, 0x7F),
        writeRegOp(0x0816, 0x02),
        writeRegOp(0x0817, 0x27),
        writeRegOp(0x0818, 0x00),
        writeRegOp(0x0819, 0x6F),
        writeRegOp(0xE04C, 0x00),
        writeRegOp(0xE04D, 0xDF),
        writeRegOp(0xE04E, 0x00),
        writeRegOp(0xE04F, 0x1F),
        writeRegOp(0x3E20, 0x01),
        writeRegOp(0x3E37, 0x00),
        writeRegOp(0x3F50, 0x00),
        writeRegOp(0x3F56, 0x00),
        writeRegOp(0x3F57, 0x56),
        writeRegOp(0X3FF9, 0x01)
        // TODO enable HDR here
      }
    },
    {"1920x1080_60fps",
      {
        writeRegOp(0x0112, 0x0A),
        writeRegOp(0x0113, 0x0A),
        writeRegOp(0x0114, 0x01),
        writeRegOp(0x0342, 0x23),
        writeRegOp(0x0343, 0x40),
        writeRegOp(0x0340, 0x06),
        writeRegOp(0x0341, 0x0F),
        writeRegOp(0x0344, 0x00),
        writeRegOp(0x0345, 0x00),
        writeRegOp(0x0346, 0x01),
        writeRegOp(0x0347, 0x78),
        writeRegOp(0x0348, 0x0F),
        writeRegOp(0x0349, 0xD7),
        writeRegOp(0x034A, 0x0A),
        writeRegOp(0x034B, 0x67),
        writeRegOp(0x00E3, 0x00),
        writeRegOp(0x00E4, 0x00),
        writeRegOp(0x00FC, 0x0A),
        writeRegOp(0x00FD, 0x0A),
        writeRegOp(0x00FE, 0x0A),
        writeRegOp(0x00FF, 0x0A),
        writeRegOp(0x0220, 0x00),
        writeRegOp(0x0221, 0x11),
        writeRegOp(0x0381, 0x01),
        writeRegOp(0x0383, 0x01),
        writeRegOp(0x0385, 0x01),
        writeRegOp(0x0387, 0x01),
        writeRegOp(0x0900, 0x01),
        writeRegOp(0x0901, 0x22),
        writeRegOp(0x0902, 0x02),
        writeRegOp(0x3140, 0x02),
        writeRegOp(0x3C00, 0x00),
        writeRegOp(0x3C01, 0x01),
        writeRegOp(0x3C02, 0x9C),
        writeRegOp(0x3F0D, 0x00),
        writeRegOp(0x5748, 0x00),
        writeRegOp(0x5749, 0x00),
        writeRegOp(0x574A, 0x00),
        writeRegOp(0x574B, 0xA4),
        writeRegOp(0x7B75, 0x0E),
        writeRegOp(0x7B76, 0x09),
        writeRegOp(0x7B77, 0x08),
        writeRegOp(0x7B78, 0x06),
        writeRegOp(0x7B79, 0x34),
        writeRegOp(0x7B53, 0x00),
        writeRegOp(0x9369, 0x73),
        writeRegOp(0x936B, 0x64),
        writeRegOp(0x936D, 0x5F),
        writeRegOp(0x9304, 0x03),
        writeRegOp(0x9305, 0x80),
        writeRegOp(0x9E9A, 0x2F),
        writeRegOp(0x9E9B, 0x2F),
        writeRegOp(0x9E9C, 0x2F),
        writeRegOp(0x9E9D, 0x00),
        writeRegOp(0x9E9E, 0x00),
        writeRegOp(0x9E9F, 0x00),
        writeRegOp(0xA2A9, 0x27),
        writeRegOp(0xA2B7, 0x03),
        writeRegOp(0x0401, 0x00),
        writeRegOp(0x0404, 0x00),
        writeRegOp(0x0405, 0x10),
        writeRegOp(0x0408, 0x00),
        writeRegOp(0x0409, 0x36),
        writeRegOp(0x040A, 0x00),
        writeRegOp(0x040B, 0x20),
        writeRegOp(0x040C, 0x07),
        writeRegOp(0x040D, 0x80),
        writeRegOp(0x040E, 0x04),
        writeRegOp(0x040F, 0x38),
        writeRegOp(0x034C, 0x07),
        writeRegOp(0x034D, 0x80),
        writeRegOp(0x034E, 0x04),
        writeRegOp(0x034F, 0x38),
        writeRegOp(0x0301, 0x05),
        writeRegOp(0x0303, 0x02),
        writeRegOp(0x0305, 0x02),
        writeRegOp(0x0306, 0x00),
        writeRegOp(0x0307, 0xAF),
        writeRegOp(0x0309, 0x0A),
        writeRegOp(0x030B, 0x01),
        writeRegOp(0x030D, 0x03),
        writeRegOp(0x030E, 0x00),
        writeRegOp(0x030F, 0x96),
        writeRegOp(0x0310, 0x01),
        writeRegOp(0x0820, 0x09),
        writeRegOp(0x0821, 0x60),
        writeRegOp(0x0822, 0x00),
        writeRegOp(0x0823, 0x00),
        writeRegOp(0x080A, 0x00),
        writeRegOp(0x080B, 0x87),
        writeRegOp(0x080C, 0x00),
        writeRegOp(0x080D, 0x4F),
        writeRegOp(0x080E, 0x00),
        writeRegOp(0x080F, 0x87),
        writeRegOp(0x0810, 0x00),
        writeRegOp(0x0811, 0x5F),
        writeRegOp(0x0812, 0x00),
        writeRegOp(0x0813, 0x5F),
        writeRegOp(0x0814, 0x00),
        writeRegOp(0x0815, 0x4F),
        writeRegOp(0x0816, 0x01),
        writeRegOp(0x0817, 0x3F),
        writeRegOp(0x0818, 0x00),
        writeRegOp(0x0819, 0x3F),
        writeRegOp(0xE04C, 0x00),
        writeRegOp(0xE04D, 0x87),
        writeRegOp(0xE04E, 0x00),
        writeRegOp(0xE04F, 0x1F),
        writeRegOp(0x3E20, 0x01),
        writeRegOp(0x3E37, 0x00),
        writeRegOp(0x3F50, 0x00),
        writeRegOp(0x3F56, 0x01),
        writeRegOp(0x3F57, 0x02),
        writeRegOp(0X3FF9, 0x01)
        // TODO enable HDR here
      }
    }
  };

  std::vector<regop_t>::const_iterator config_it;
  std::vector<regop_t> config_vec;

  uint32_t frame_length;

  bool config_ok = false;

  camera_init_ret_t camera_init_config(usb_txrx_i2c_t& i2c_pkt);

public:
  // Used in external function
  static constexpr uint8_t SLAVE_ADDR = 0x1A;
  static constexpr uint8_t SUBADDR_SIZE = 0x2; // in bytes
  static constexpr uint8_t REGISTER_SIZE = 0x1; // in bytes

  static void fillProbePkt(usb_txrx_i2c_t& probe_pkt);

  static bool checkProbePkt(usb_txrx_i2c_t& probe_pkt);

  virtual sensor_type_t getType() const override;

  virtual camera_init_ret_t initialise(const std::string& config_name, usb_txrx_i2c_t& i2c_pkt) override;

  bool set_config(const std::string& config_name);

  virtual void enableStreaming(usb_txrx_i2c_t& i2c_pkt) override;

  virtual void updateExposure(usb_txrx_i2c_t& i2c_pkt) override;

  virtual void reset(usb_txrx_i2c_t& i2c_pkt) override;
};

#endif
